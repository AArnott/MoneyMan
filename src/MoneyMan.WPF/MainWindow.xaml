<Window x:Class="MoneyMan.MainWindow"
		xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
		xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
		xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
		xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"	
		xmlns:local="clr-namespace:MoneyMan.ViewModel"
		xmlns:vm="clr-namespace:Nerdbank.MoneyManagement.ViewModels;assembly=Nerdbank.MoneyManagement"
		xmlns:componentmodel="clr-namespace:System.ComponentModel;assembly=WindowsBase"
		xmlns:converters="clr-namespace:MoneyMan.Converters"
		mc:Ignorable="d"
		Title="{Binding Document.Title}" Height="456" Width="762">
	<Window.Resources>
		<local:MainPageViewModel x:Key="viewModel" />
		<converters:NullToVisibilityConverter x:Key="nullToVisibilityConverter" />
		<converters:NumberOrNullConverter x:Key="numberOrNullConverter" />
		<BooleanToVisibilityConverter x:Key="boolToVisibilityConverter" />
	</Window.Resources>
	<DockPanel DataContext="{Binding Source={StaticResource viewModel}, Path=Document}">
		<Menu DockPanel.Dock="Top">
			<MenuItem Header="_File">
				<MenuItem Header="_New" Command="ApplicationCommands.New" />
				<MenuItem Header="_Open" Command="ApplicationCommands.Open" />
				<MenuItem Header="_Close" Command="ApplicationCommands.Close" />
			</MenuItem>
		</Menu>
		<ToolBarTray DockPanel.Dock="Top" Visibility="Collapsed">
			<ToolBar>
				<Button Command="NavigationCommands.BrowseBack">
					Back
				</Button>
				<Button Command="NavigationCommands.BrowseForward">
					Forward
				</Button>
			</ToolBar>
		</ToolBarTray>
		<TabControl TabStripPlacement="Bottom"
					Visibility="{Binding IsFileOpen, Converter={StaticResource boolToVisibilityConverter}}">
			<TabItem Header="Banking" DataContext="{Binding BankingPanel}">
				<TabItem.Resources>
					<CollectionViewSource Source="{Binding Accounts}" x:Key="accounts" />
				</TabItem.Resources>
				<Grid>
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="1*" />
						<ColumnDefinition Width="4*" />
					</Grid.ColumnDefinitions>
					<DockPanel Grid.Column="0">
						<DockPanel DockPanel.Dock="Bottom" Margin="5">
							<TextBlock DockPanel.Dock="Right" Text="{Binding Source={StaticResource viewModel}, Path=Document.NetWorth, StringFormat=C}" FontWeight="Bold" />
							<TextBlock Text="Net worth" FontWeight="Bold" />
						</DockPanel>
						<ListView ItemsSource="{Binding Source={StaticResource accounts}}" IsSynchronizedWithCurrentItem="True" SelectedItem="{Binding SelectedAccount}" HorizontalContentAlignment="Stretch" SelectionMode="Single">
							<ListView.ItemTemplate>
								<DataTemplate>
									<DockPanel>
										<TextBlock Text="{Binding Balance, StringFormat=C}" DockPanel.Dock="Right" />
										<TextBlock Text="{Binding Name}" />
									</DockPanel>
								</DataTemplate>
							</ListView.ItemTemplate>
						</ListView>
					</DockPanel>
					<DockPanel Grid.Column="1"
							   DataContext="{Binding SelectedAccount}" 
							   Visibility="{Binding Converter={StaticResource nullToVisibilityConverter}}">
						<DockPanel.Resources>
							<CollectionViewSource Source="{Binding Transactions}" x:Key="transactions" IsLiveSortingRequested="True">
								<CollectionViewSource.SortDescriptions>
									<componentmodel:SortDescription PropertyName="When" />
								</CollectionViewSource.SortDescriptions>
							</CollectionViewSource>
						</DockPanel.Resources>
						<Label Content="{Binding Name}" DockPanel.Dock="Top" FontSize="14pt" FontWeight="Bold" />
						<DataGrid Name="TransactionDataGrid"
								  AlternatingRowBackground="LightBlue"
								  AlternationCount="2" 
								  ItemsSource="{Binding Source={StaticResource transactions}}"
								  IsSynchronizedWithCurrentItem="True"
								  SelectedItem="{Binding Document.SelectedTransaction, Source={StaticResource viewModel}, Mode=TwoWay}"
								  AddingNewItem="TransactionGrid_AddingNewItem"
								  AutoGenerateColumns="False">
							<DataGrid.Columns>
								<DataGridTemplateColumn Header="Date">
									<DataGridTemplateColumn.CellTemplate>
										<DataTemplate>
											<DatePicker SelectedDate="{Binding When, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
										</DataTemplate>
									</DataGridTemplateColumn.CellTemplate>
								</DataGridTemplateColumn>
								<DataGridTemplateColumn Header="Payee">
									<DataGridTemplateColumn.CellTemplate>
										<DataTemplate>
											<TextBlock Text="{Binding Payee, Mode=OneWay}" Margin="3pt" />
										</DataTemplate>
									</DataGridTemplateColumn.CellTemplate>
									<DataGridTemplateColumn.CellEditingTemplate>
										<DataTemplate>
											<TextBox Text="{Binding Payee, Mode=TwoWay, UpdateSourceTrigger=LostFocus}" />
										</DataTemplate>
									</DataGridTemplateColumn.CellEditingTemplate>
								</DataGridTemplateColumn>
								<DataGridTemplateColumn Header="Category">
									<DataGridTemplateColumn.CellTemplate>
										<DataTemplate>
											<TextBlock Text="{Binding CategoryOrTransfer.TransferTargetName}" Margin="3pt" />
										</DataTemplate>
									</DataGridTemplateColumn.CellTemplate>
									<DataGridTemplateColumn.CellEditingTemplate>
										<DataTemplate>
											<ComboBox
												ItemsSource="{Binding Source={StaticResource viewModel}, Path=Document.TransactionTargets}"
												SelectedItem="{Binding CategoryOrTransfer, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
												<ComboBox.ItemTemplate>
													<DataTemplate>
														<TextBlock Text="{Binding TransferTargetName}" />
													</DataTemplate>
												</ComboBox.ItemTemplate>
											</ComboBox>
										</DataTemplate>
									</DataGridTemplateColumn.CellEditingTemplate>
								</DataGridTemplateColumn>
								<DataGridTemplateColumn Header="Memo">
									<DataGridTemplateColumn.CellTemplate>
										<DataTemplate>
											<TextBlock Text="{Binding Memo, Mode=OneWay}" Margin="3pt" />
										</DataTemplate>
									</DataGridTemplateColumn.CellTemplate>
									<DataGridTemplateColumn.CellEditingTemplate>
										<DataTemplate>
											<TextBox Text="{Binding Memo, Mode=TwoWay, UpdateSourceTrigger=LostFocus}" />
										</DataTemplate>
									</DataGridTemplateColumn.CellEditingTemplate>
								</DataGridTemplateColumn>
								<DataGridTemplateColumn Header="Amount">
									<DataGridTemplateColumn.CellTemplate>
										<DataTemplate>
											<TextBlock Margin="3pt" Text="{Binding Amount, StringFormat=C}" HorizontalAlignment="Right" />
										</DataTemplate>
									</DataGridTemplateColumn.CellTemplate>
									<DataGridTemplateColumn.CellEditingTemplate>
										<DataTemplate>
											<TextBox Text="{Binding Amount, Mode=TwoWay, UpdateSourceTrigger=LostFocus}" InputScope="Number" />
										</DataTemplate>
									</DataGridTemplateColumn.CellEditingTemplate>
								</DataGridTemplateColumn>
								<DataGridTextColumn Header="Check No." Binding="{Binding CheckNumber, Converter={StaticResource numberOrNullConverter}}" />
								<DataGridTemplateColumn Header="Clr">
									<DataGridTemplateColumn.CellTemplate>
										<DataTemplate>
											<TextBlock Margin="3pt" Text="{Binding Cleared.ShortCaption}" />
										</DataTemplate>
									</DataGridTemplateColumn.CellTemplate>
									<DataGridTemplateColumn.CellEditingTemplate>
										<DataTemplate>
											<ComboBox SelectedItem="{Binding Cleared, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
											          ItemsSource="{Binding ClearedStates}"
											          DisplayMemberPath="Caption" 
											          SelectedValuePath="Value" />
										</DataTemplate>
									</DataGridTemplateColumn.CellEditingTemplate>
								</DataGridTemplateColumn>
								<DataGridTextColumn Header="Balance" IsReadOnly="True" />
							</DataGrid.Columns>
							<DataGrid.ContextMenu>
								<ContextMenu>
									<MenuItem Header="_Delete" Command="{Binding Document.DeleteTransactionsCommand, Source={StaticResource viewModel}}" />
								</ContextMenu>
							</DataGrid.ContextMenu>
						</DataGrid>
					</DockPanel>
				</Grid>
			</TabItem>
			<TabItem Header="Categories" DataContext="{Binding CategoriesPanel}" Height="20" VerticalAlignment="Top">
				<TabItem.Resources>
					<CollectionViewSource Source="{Binding Categories}" x:Key="categories" IsLiveSortingRequested="True">
						<CollectionViewSource.SortDescriptions>
							<componentmodel:SortDescription PropertyName="Name" />
						</CollectionViewSource.SortDescriptions>
					</CollectionViewSource>
					<Style x:Key="textBoxInError" TargetType="{x:Type TextBox}">
						<Style.Triggers>
							<Trigger Property="Validation.HasError" Value="True">
								<Setter Property="Background" Value="Pink" />
								<Setter Property="ToolTip"
									Value="{Binding RelativeSource={x:Static RelativeSource.Self}, Path=(Validation.Errors)/ErrorContent}" />
							</Trigger>
						</Style.Triggers>
					</Style>
				</TabItem.Resources>
				<DockPanel>
					<StackPanel Margin="5,0,5,0" DockPanel.Dock="Right" Width="150pt" DataContext="{StaticResource categories}">
						<Label Content="_Name" Target="{Binding ElementName=CategoryName}" />
						<TextBox Name="CategoryName"
								 MaxLength="100"
								 Style="{StaticResource textBoxInError}"
								 Text="{Binding Name, UpdateSourceTrigger=LostFocus, NotifyOnValidationError=True, ValidatesOnDataErrors=True}">
						</TextBox>
					</StackPanel>
					<Button Content="_Add new" DockPanel.Dock="Bottom" Command="{Binding AddCommand}" />
					<ListView Name="CategoriesListView" ItemsSource="{Binding Source={StaticResource categories}}" IsSynchronizedWithCurrentItem="True" SelectedItem="{Binding SelectedCategory, Mode=TwoWay}">
						<ListView.ItemContainerStyle>
							<Style TargetType="ListBoxItem">
								<Setter Property="ContextMenu">
									<Setter.Value>
										<ContextMenu DataContext="{Binding Document.CategoriesPanel, Source={StaticResource viewModel}}">
											<MenuItem Header="{Binding DeleteCommand.Caption}" Command="{Binding DeleteCommand}" />
										</ContextMenu>
									</Setter.Value>
								</Setter>
							</Style>
						</ListView.ItemContainerStyle>
						<ListView.ItemTemplate>
							<DataTemplate>
								<TextBlock Text="{Binding Name}" />
							</DataTemplate>
						</ListView.ItemTemplate>
					</ListView>
				</DockPanel>
			</TabItem>
		</TabControl>
	</DockPanel>
</Window>
