<Window x:Class="MoneyMan.MainWindow"
		xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
		xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
		xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
		xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"	
		xmlns:local="clr-namespace:MoneyMan.ViewModel"
		xmlns:vm="clr-namespace:Nerdbank.MoneyManagement.ViewModels;assembly=Nerdbank.MoneyManagement"
		xmlns:componentmodel="clr-namespace:System.ComponentModel;assembly=WindowsBase"
		xmlns:converters="clr-namespace:MoneyMan.Converters"
		mc:Ignorable="d"
		Title="{Binding Document.Title}" Height="456" Width="762">
	<Window.Resources>
		<local:MainPageViewModel x:Key="viewModel" />
		<converters:NullToVisibilityConverter x:Key="nullToVisibilityConverter" />
	</Window.Resources>
	<DockPanel DataContext="{Binding Source={StaticResource viewModel}, Path=Document}">
		<Menu DockPanel.Dock="Top">
			<MenuItem Header="_File">
				<MenuItem Header="_New" Command="ApplicationCommands.New" />
				<MenuItem Header="_Open" Command="ApplicationCommands.Open" />
				<MenuItem Header="_Close" Command="ApplicationCommands.Close" />
			</MenuItem>
		</Menu>
		<ToolBarTray DockPanel.Dock="Top" Visibility="Collapsed">
			<ToolBar>
				<Button Command="NavigationCommands.BrowseBack">
					Back
				</Button>
				<Button Command="NavigationCommands.BrowseForward">
					Forward
				</Button>
			</ToolBar>
		</ToolBarTray>
		<TabControl TabStripPlacement="Bottom">
			<TabItem Header="Accounts" DataContext="{Binding AccountsPanel}">
				<TabItem.Resources>
					<CollectionViewSource Source="{Binding Accounts}" x:Key="accounts" />
				</TabItem.Resources>
				<Grid>
					<Grid.ColumnDefinitions>
						<ColumnDefinition Width="1*" />
						<ColumnDefinition Width="4*" />
					</Grid.ColumnDefinitions>
					<ListView ItemsSource="{Binding Source={StaticResource accounts}}" IsSynchronizedWithCurrentItem="True" SelectedItem="{Binding SelectedAccount}" Grid.Column="0">
						<ListView.ItemTemplate>
							<DataTemplate>
								<TextBlock Text="{Binding Name}" />
							</DataTemplate>
						</ListView.ItemTemplate>
					</ListView>
					<DockPanel Grid.Column="1"
							   DataContext="{Binding SelectedAccount}" 
							   Visibility="{Binding Converter={StaticResource nullToVisibilityConverter}}">
						<Label Content="{Binding Name}" DockPanel.Dock="Top" FontSize="14pt" FontWeight="Bold" />
						<DataGrid AlternatingRowBackground="LightBlue"
								  AlternationCount="2" 
								  ItemsSource="{Binding Transactions}" 
								  SelectedItem="{Binding SelectedTransaction, Mode=TwoWay}"
								  AutoGenerateColumns="False">
							<DataGrid.Columns>
								<DataGridTemplateColumn Header="Date">
									<DataGridTemplateColumn.CellTemplate>
										<DataTemplate>
											<DatePicker SelectedDate="{Binding When}" />
										</DataTemplate>
									</DataGridTemplateColumn.CellTemplate>
								</DataGridTemplateColumn>
								<DataGridTextColumn Header="Check No." Binding="{Binding CheckNumber}" />
								<DataGridTemplateColumn Header="Payee">
									<DataGridTemplateColumn.CellTemplate>
										<DataTemplate>
											<TextBlock Text="{Binding Payee.Name, Mode=OneWay}" Margin="3pt" />
										</DataTemplate>
									</DataGridTemplateColumn.CellTemplate>
									<DataGridTemplateColumn.CellEditingTemplate>
										<DataTemplate>
											<ComboBox IsEditable="True" 
											          ItemsSource="{Binding Source={StaticResource viewModel}, Path=Document.Payees}"
											          DisplayMemberPath="Name"
											          SelectedItem="{Binding Payee, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />
										</DataTemplate>
									</DataGridTemplateColumn.CellEditingTemplate>
								</DataGridTemplateColumn>
								<DataGridTemplateColumn Header="Category">
									<DataGridTemplateColumn.CellTemplate>
										<DataTemplate>
											<TextBlock Text="{Binding Category.Name}" Margin="3pt" />
										</DataTemplate>
									</DataGridTemplateColumn.CellTemplate>
									<DataGridTemplateColumn.CellEditingTemplate>
										<DataTemplate>
											<ComboBox
												ItemsSource="{Binding Source={StaticResource viewModel}, Path=Document.CategoriesPanel.Categories}"
												SelectedItem="{Binding Category, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
												<ComboBox.ItemTemplate>
													<DataTemplate>
														<TextBlock Text="{Binding Name}" />
													</DataTemplate>
												</ComboBox.ItemTemplate>
											</ComboBox>
										</DataTemplate>
									</DataGridTemplateColumn.CellEditingTemplate>
								</DataGridTemplateColumn>
								<DataGridTextColumn Header="Memo" Binding="{Binding Memo}" />
								<DataGridTemplateColumn Header="Amount">
									<DataGridTemplateColumn.CellTemplate>
										<DataTemplate>
											<TextBlock Margin="3pt" Text="{Binding Amount}" HorizontalAlignment="Right" />
										</DataTemplate>
									</DataGridTemplateColumn.CellTemplate>
									<DataGridTemplateColumn.CellEditingTemplate>
										<DataTemplate>
											<TextBox Text="{Binding Amount, Mode=TwoWay, UpdateSourceTrigger=LostFocus}" InputScope="Number" />
										</DataTemplate>
									</DataGridTemplateColumn.CellEditingTemplate>
								</DataGridTemplateColumn>
								<DataGridTemplateColumn Header="Clr">
									<DataGridTemplateColumn.CellTemplate>
										<DataTemplate>
											<TextBlock Margin="3pt" Text="{Binding Cleared.ShortCaption}" />
										</DataTemplate>
									</DataGridTemplateColumn.CellTemplate>
									<DataGridTemplateColumn.CellEditingTemplate>
										<DataTemplate>
											<ComboBox SelectedItem="{Binding Cleared, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
											          ItemsSource="{Binding ClearedStates}"
											          DisplayMemberPath="Caption" 
											          SelectedValuePath="Value" />
										</DataTemplate>
									</DataGridTemplateColumn.CellEditingTemplate>
								</DataGridTemplateColumn>
								<DataGridTextColumn Header="Balance" IsReadOnly="True" />
							</DataGrid.Columns>
							<DataGrid.ContextMenu>
								<ContextMenu>
									<MenuItem Header="_Delete" Command="{Binding DeleteTransactionCommand}" />
								</ContextMenu>
							</DataGrid.ContextMenu>
							<DataGrid.RowStyle>
								<Style TargetType="{x:Type DataGridRow}">
									<Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
								</Style>
							</DataGrid.RowStyle>
						</DataGrid>
					</DockPanel>
				</Grid>
			</TabItem>
			<TabItem Header="Categories" DataContext="{Binding CategoriesPanel}" Height="20" VerticalAlignment="Top">
				<TabItem.Resources>
					<CollectionViewSource Source="{Binding Categories}" x:Key="categories" IsLiveSortingRequested="True">
						<CollectionViewSource.SortDescriptions>
							<componentmodel:SortDescription PropertyName="Name" />
						</CollectionViewSource.SortDescriptions>
					</CollectionViewSource>
					<Style x:Key="textBoxInError" TargetType="{x:Type TextBox}">
						<Style.Triggers>
							<Trigger Property="Validation.HasError" Value="True">
								<Setter Property="Background" Value="Pink" />
								<Setter Property="ToolTip"
									Value="{Binding RelativeSource={x:Static RelativeSource.Self}, Path=(Validation.Errors)/ErrorContent}" />
							</Trigger>
						</Style.Triggers>
					</Style>
				</TabItem.Resources>
				<DockPanel>
					<DockPanel DockPanel.Dock="Right" Width="150pt" >
						<Button Content="_Delete" DockPanel.Dock="Bottom" Command="{Binding DeleteCommand}" />
						<StackPanel Margin="5,0,5,0" DataContext="{StaticResource categories}">
							<Label Content="_Name" Target="{Binding ElementName=CategoryName}" />
							<TextBox Name="CategoryName"
								 MaxLength="100"
								 Style="{StaticResource textBoxInError}">
								<TextBox.Text>
									<Binding Path="Name" UpdateSourceTrigger="LostFocus">
										<Binding.ValidationRules>
											<ExceptionValidationRule />
										</Binding.ValidationRules>
									</Binding>
								</TextBox.Text>
							</TextBox>
						</StackPanel>
					</DockPanel>
					<Button Content="_Add new" DockPanel.Dock="Bottom" Command="{Binding AddCommand}" />
					<ListView ItemsSource="{Binding Source={StaticResource categories}}" IsSynchronizedWithCurrentItem="True" SelectedItem="{Binding SelectedCategory}">
						<ListView.ItemTemplate>
							<DataTemplate>
								<TextBlock Text="{Binding Name}" />
							</DataTemplate>
						</ListView.ItemTemplate>
					</ListView>
				</DockPanel>
			</TabItem>
		</TabControl>
	</DockPanel>
</Window>
